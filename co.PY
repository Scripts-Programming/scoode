import requests
import json
import re
from datetime import datetime
import time
import os  # 住

'''

 转 砖专转   漏
驻转 转转 (驻转,  住拽专驻-' 住拽专驻 ' ')
爪专转 拽砖专 驻专 住驻:
8582511c@gmail.com
 注转拽, 砖驻  拽  拽转 砖专 砖砖 拽
 注转拽, 砖驻 注专 注 砖专 
''' 
# 专转
FOLDER_ID = '1DUCfXOMJnWB62INhajm_irJPPKDnFqsV'



TELEGRAM_CHANNELS = [
    {"url": "https://t.me/s/divuhim1234"},  #   砖
    {"url": "https://t.me/s/PikudHaOref_all"},  # 驻拽 注专祝 -  注转
    {"url": "https://t.me/s/abualiexpress"},  #  注 拽住驻专住
    {"url": "https://t.me/s/amitsegal"},  # 注转 住
    {"url": "https://t.me/s/merkaz"},  # 专 砖转
    {"url": "https://t.me/s/lieldaphna"},  #  驻
    {"url": "https://t.me/s/News_cabinet_news"},  # 砖转 砖
    {"url": "https://t.me/s/ynetalerts"},  # ynet - 注
    {"url": "https://t.me/s/ramreports"},  # 专 专住 - 
    {"url": "https://t.me/s/news00009"},  # 砖转 00009
    {"url": "https://t.me/s/yedidya_epshteyn"},  #  驻砖
    {"url": "https://t.me/s/HallelBittonRosen"},  #   专
    {"url": "https://t.me/s/yediyot_bnei_brak"},  # 注转  专拽
    {"url": "https://t.me/s/kolahadasot"},  # 拽 砖转
    {"url": "https://t.me/s/yinonews"},  # 注转  
    {"url": "https://t.me/s/Newss0nline"},  # 砖转  
    {"url": "https://t.me/s/pkpoi"},  # 驻拽住 驻
    {"url": "https://t.me/s/Now14israel"},  # 注砖 14
    {"url": "https://t.me/s/firstreportsnews"},  #  专砖
    {"url": "https://t.me/s/TheBigBadShadow"},  # 爪
    {"url": "https://t.me/s/tzviye"},  # 爪 拽
    {"url": "https://t.me/s/NTD_Hebrew"},  # NTD 注专转
    {"url": "https://t.me/s/bnetanyahu"},  #  转
    {"url": "https://t.me/s/YLapid"},  # 专 驻
    {"url": "https://t.me/s/yarivlevin"},  # 专 
    {"url": "https://t.me/s/ayeletshaked1"},  # 转 砖拽
    {"url": "https://t.me/s/yairsherkinews"},  # 专 砖专拽
    {"url": "https://t.me/s/mivzakibitahon"},  # 拽  - 砖专 
    {"url": "https://t.me/s/N12_News"},  # 砖转 12
    {"url": "https://t.me/s/behadrei_harebim_bhol"},  # 专 专
    {"url": "https://t.me/s/idf_telegram"},  # 爪  砖专
    {"url": "https://t.me/s/JewishFist"},  # 专祝 
    {"url": "https://t.me/s/arabworld301news"},  # 注 注专 - 砖转
    {"url": "https://t.me/s/israel_news_telegram"},  # 砖转 砖专
    {"url": "https://t.me/s/GLOBAL_Telegram_MOKED"},  # 拽 砖转 - 
    {"url": "https://t.me/s/knessettv"},  # 注专抓 住转
    {"url": "https://t.me/s/hadasot10"},  # 砖转 10
    {"url": "https://t.me/s/New_security8200"},  # 砖转  8200
    {"url": "https://t.me/s/hazfon1"},  # 砖转 爪驻 1
    {"url": "https://t.me/s/Yotamzimritelegram"},  # 转 专
    {"url": "https://t.me/s/elisha_yered"},  # 砖注 专
    {"url": "https://t.me/s/filbers"},  # 驻专
    {"url": "https://t.me/s/amirbohbot"},  # 专 
    {"url": "https://t.me/s/realelchangr"},  #  专专
    {"url": "https://t.me/s/FidYamin"},  # 驻 
    {"url": "https://t.me/s/nilchamim"},  #  注 转
    {"url": "https://t.me/s/tamirmorag14"},  # 转专 专
    {"url": "https://t.me/bengvir"},  # 转专  专
    {"url": "https://t.me/s/ZakaHQ"},  # 拽"
    {"url": "https://t.me/s/mdaisrael"},  #   
    {"url": "https://t.me/s/uh1221"},  #  爪
    {"url": "https://t.me/s/techisrael"},  # 拽 砖专
    {"url": "https://t.me/s/tzap1"}  # 爪驻 
]
GOOGLE_CHAT_WEBHOOK_URL = "https://chat.googleapis.com/v1/spaces/AAQA1-801Ro/messages?key=AIzaSyDdI0hCZtE6vySjMm-WEfRq3CPzqKqqsHI&token=_yfpt_D9lg7RZhofYRmrlPSseHbx6YeEnrbMgq4RwIk"
DELAY_BETWEEN_MESSAGES_MS = 1  # 驻转,  芯卸懈写邪薪懈  砖转

# 住 注 注 注 专 (转 砖转砖 住 转  拽抓)
last_message_ids = {}
def fetch_url(url):
    try:
        response = requests.get(url, verify=False)  # 住驻 verify=False 
        response.raise_for_status()  # 注 专 注专 拽 住住 砖
        return response.text
    except requests.exceptions.RequestException as e:
        print(f"砖 砖驻转 祝 专: {url} - {e}")
        return None

def get_channel_info(html_content):
    name_match = re.search(r'<meta property="og:title" content="([^"]+)"', html_content)
    image_match = re.search(r'<meta property="og:image" content="([^"]+)"', html_content)
    return {
        "name": name_match.group(1) if name_match else "注专抓  注",
        "imageUrl": image_match.group(1) if image_match else ""
    }

def clean_text(text):
    text = re.sub(r'<br\s*\/?>', '\n', text)
    text = re.sub(r'<[^>]+>', '', text)
    text = text.replace('&quot;', '"').replace('&amp;', '&').replace('&lt;', '<').replace('&gt;', '>')
    text = re.sub(r'https?:\/\/chat\.whatsapp\.com\/[^\s]+', '', text)
    text = re.sub(r'https?:\/\/wa\.link\/[^\s]+', '', text)
    text = re.sub(r'\s*爪专驻转 住驻:\s*\n?', '', text)
    text = re.sub(r'\s*住住:\s*\n?', '', text)
    text = re.sub(r'https?:\/\/t\.me\/[^\s]+', '', text)
    text = re.sub(r'https?:\/\/telegram\.me\/[^\s]+', '', text)
    text = re.sub(r'\s*爪专驻 注专抓 专 砖:\s*\n?', '', text)
    text = re.sub(r'驻  - The Right Way 专: [^\s]*', '', text)
    text = re.sub(r'驻  - The Right Way 住驻: [^\s]*', '', text)
    text = re.sub(r'https?:\/\/did\.li\/FidYamin', '', text)
    text = re.sub(r'砖转祝 WhatsApp .:', '', text)
    text = re.sub(r"注拽 专 '砖转   爪专'  驻驻专转: 住专 \| 拽拽 \| 专", '', text)
    text = re.sub(r' 爪专 砖转 砖专 专: [^\s]*', '', text)
    text = re.sub(r'拽爪转 住驻: [^\s]*', '', text)
    return text.strip()

def parse_messages_from_html(html_content):
    messages = []
    message_blocks = re.findall(r'<div class="tgme_widget_message_wrap js-widget_message_wrap"[\s\S]*?<\/div><\/div>', html_content)
    for block in message_blocks:
        id_match = re.search(r'data-post="[^"]*?\/(\d+)"', block)
        if not id_match:
            continue
        message_id = int(id_match.group(1))
        text_match = re.search(r'<div class="tgme_widget_message_text js-message_text"[^>]*>([\s\S]*?)<\/div>', block)
        text = clean_text(text_match.group(1)) if text_match else ""
        text = re.sub(r'https:\/\/drive\.google\.com\/file\/d\/([^\/]+)\/view\?usp=[^&]+', r'https://drive.google.com/file/d/\1/view?usp=drivesdk', text)
        text = re.sub(r'(https?:\/\/[^\s]+)', r'<a href="\1">\1</a>', text)
        image_match = re.search(r'background-image:url\([\'"]?([^\'"\)]+)[\'"]?\)', block)
        image_url = image_match.group(1) if image_match else ""
        video_match = re.search(r'<video[^>]+src="([^"]+)"', block)
        video_url = video_match.group(1) if video_match else ""
        time_match = re.search(r'<time datetime="([^"]+)"', block)
        timestamp_str = time_match.group(1) if time_match else None
        timestamp = datetime.fromisoformat(timestamp_str) if timestamp_str else datetime.now()
        messages.append({
            "id": message_id,
            "text": text,
            "imageUrl": image_url,
            "videoUrl": video_url,
            "timestamp": timestamp.isoformat()
        })
    return sorted(messages, key=lambda x: x["id"])  # <-- 砖专  爪专 转 转 驻
# 驻拽爪 注转 住专 专 (专砖转 专爪 注 Google Drive API)
def upload_video_to_drive(url):
    print(f"驻拽爪 upload_video_to_drive 拽 转 拽砖专: {url}. 砖 砖 专爪 注 Google Drive API .")
    #  转爪专 砖转砖 住驻专转 google-api-python-client  爪注 注 专
    #   专砖转, 爪专转 砖专转 专 '.
    # 专注, 专 None  placeholder.
    return None

def send_card_to_google_chat(message, channel_info):
    formatted_date = datetime.fromisoformat(message["timestamp"]).strftime("%d/%m/%Y %H:%M:%S")
    sections = []
    if message["text"].strip():
        sections.append({"widgets": [{"textParagraph": {"text": message["text"]}}]})
    if message["imageUrl"]:
        sections.append({"widgets": [{"image": {"imageUrl": message["imageUrl"]}}]})
    if message["videoUrl"]:
        sections.append({"widgets": [{"textParagraph": {"text": f" <a href='{message['videoUrl']}'>抓  爪驻 住专</a>"}}]})

    if not sections:
        return

    card = {
        "cardsV2": [
            {
                "cardId": "telegramMessage",
                "card": {
                    "header": {
                        "title": channel_info["name"],
                        "subtitle": formatted_date,
                        "imageUrl": channel_info["imageUrl"],
                        "imageType": "CIRCLE"
                    },
                    "sections": sections
                }
            }
        ]
    }
    try:
        response = requests.post(GOOGLE_CHAT_WEBHOOK_URL, headers={'Content-Type': 'application/json'}, data=json.dumps(card))
        response.raise_for_status()
        print(f"注 砖 -Google Chat 爪 注专 注 {message['id']} 注专抓 {channel_info['name']}")
    except requests.exceptions.RequestException as e:
        print(f"砖 砖转 注 -Google Chat: {e}")

def check_for_new_messages():
    for channel in TELEGRAM_CHANNELS:
        channel_url = channel["url"]
        last_message_id = last_message_ids.get(channel_url, 0)
        html_content = fetch_url(channel_url)
        if html_content:
            channel_info = get_channel_info(html_content)
            messages = parse_messages_from_html(html_content)
            new_last_message_id = last_message_id
            for message in messages:
                if message["id"] > last_message_id:
                    if message["videoUrl"]:
                        message["videoUrl"] = upload_video_to_drive(message["videoUrl"])
                    send_card_to_google_chat(message, channel_info)
                    new_last_message_id = max(new_last_message_id, message["id"])
                    time.sleep(DELAY_BETWEEN_MESSAGES_MS)
            if new_last_message_id > last_message_id:
                last_message_ids[channel_url] = new_last_message_id

if __name__ == "__main__":
    #  拽 专抓   驻 转 砖转专
    while True:
        check_for_new_messages()
        time.sleep(1)  # 拽  拽 (转 砖转)