<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>住驻转 住驻专 / </title>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background: linear-gradient(135deg, #f0f4f8, #d9e2ec);
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
    }

    .container {
      background: #ffffff;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
      max-width: 400px;
      width: 100%;
    }

    h1 {
      text-align: center;
      color: #003366;
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      color: #333;
    }

    input[type="text"], select {
      width: 100%;
      padding: 10px;
      margin-bottom: 15px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 16px;
    }

    button {
      width: 100%;
      background-color: #0066cc;
      color: white;
      border: none;
      padding: 12px;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    button:hover {
      background-color: #004999;
    }

    #result {
      margin-top: 15px;
      text-align: center;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>住驻转 住驻专 / </h1>
    <label for="bookName">砖 住驻专</label>
    <input type="text" id="bookName" placeholder=": 住注转 专" />

    <label for="action">住 驻注</label>
    <select id="action">
      <option value="add">住驻转 住驻专</option>
      <option value="order">转 住驻专</option>
    </select>

    <button onclick="sendData()">砖</button>
    <p id="result"></p>
  </div>

  <script>
const CACHE = CacheService.getScriptCache();
const FOLDER_ID = '1J-80Xhpth2_BhM8Vjdxe0dfHG_ApKre7';

const emails = [
    { email: "admin@miil-niol.top", name: " 专砖" },
  { email: "admin@miil-niol.top", name: " " },
  { email: "mtzix@miil-niol.top", name: "爪转 拽住驻专住" }, 
  { email: "abctodros@hamakom.ovh", name: "住" },
  { email: "muhk@miil-niol.top", name: " 拽爪转" },
    { email: "script-coode@hamakom.ovh", name: "住拽专驻 转转" },
  { email: "76as@miil-niol.top", name: "砖 砖砖转" },
];

const email = Session.getActiveUser().getEmail(); 
const props = PropertiesService.getScriptProperties(); // 砖砖 -Script Properties 砖专转 爪 砖转祝

const TELEGRAM_CHANNELS = [
  { url: "https://t.me/s/divuhim1234"}, //   砖
  { url: "https://t.me/s/PikudHaOref_all"}, // 驻拽 注专祝 -  注转
  { url: "https://t.me/s/abualiexpress"}, //  注 拽住驻专住
  { url: "https://t.me/s/amitsegal"}, // 注转 住
  { url: "https://t.me/s/merkaz"}, // 专 砖转
  { url: "https://t.me/s/lieldaphna"}, //  驻
  { url: "https://t.me/s/News_cabinet_news"}, // 砖转 砖
  { url: "https://t.me/s/ynetalerts"}, // ynet - 注
  { url: "https://t.me/s/ramreports"}, // 专 专住 - 
  { url: "https://t.me/s/news00009"}, // 砖转 00009
  { url: "https://t.me/s/yedidya_epshteyn"}, //  驻砖
  { url: "https://t.me/s/HallelBittonRosen"}, //   专
  { url: "https://t.me/s/yediyot_bnei_brak"}, // 注转  专拽
  { url: "https://t.me/s/kolahadasot"}, // 拽 砖转
  { url: "https://t.me/s/yinonews"}, // 注转  
  { url: "https://t.me/s/Newss0nline"}, // 砖转  
  { url: "https://t.me/s/pkpoi"}, // 驻拽住 驻
  { url: "https://t.me/s/Now14israel"}, // 注砖 14
  { url: "https://t.me/s/firstreportsnews"}, //  专砖
  { url: "https://t.me/s/TheBigBadShadow"}, // 爪
  { url: "https://t.me/s/tzviye"}, // 爪 拽
  { url: "https://t.me/s/NTD_Hebrew"}, // NTD 注专转
  { url: "https://t.me/s/bnetanyahu"}, //  转
  { url: "https://t.me/s/YLapid"}, // 专 驻
  { url: "https://t.me/s/yarivlevin"}, // 专 
  { url: "https://t.me/s/ayeletshaked1"}, // 转 砖拽
  { url: "https://t.me/s/yairsherkinews"}, // 专 砖专拽
  { url: "https://t.me/s/mivzakibitahon"}, // 拽  - 砖专 
  { url: "https://t.me/s/N12_News"}, // 砖转 12
  { url: "https://t.me/s/behadrei_harebim_bhol"}, // 专 专
  { url: "https://t.me/s/idf_telegram"}, // 爪  砖专
  { url: "https://t.me/s/JewishFist"}, // 专祝 
  { url: "https://t.me/s/arabworld301news"}, // 注 注专 - 砖转
  { url: "https://t.me/s/israel_news_telegram"}, // 砖转 砖专
  { url: "https://t.me/s/GLOBAL_Telegram_MOKED"}, // 拽 砖转 - 
  { url: "https://t.me/s/knessettv"}, // 注专抓 住转
  { url: "https://t.me/s/hadasot10"}, // 砖转 10
  { url: "https://t.me/s/New_security8200"}, // 砖转  8200
  { url: "https://t.me/s/hazfon1"}, // 砖转 爪驻 1
  { url: "https://t.me/s/Yotamzimritelegram"}, // 转 专
  { url: "https://t.me/s/elisha_yered"}, // 砖注 专
  { url: "https://t.me/s/filbers"}, // 驻专
  { url: "https://t.me/s/amirbohbot"}, // 专 
  { url: "https://t.me/s/realelchangr"}, //  专专
  { url: "https://t.me/s/FidYamin"}, // 驻 
  { url: "https://t.me/s/tamirmorag14"}, // 转专 专
  { url: "https://t.me/bengvir"}, // 转专  专
  { url: "https://t.me/s/ZakaHQ"}, // 拽"
  { url: "https://t.me/s/mdaisrael"}, //   
  { url: "https://t.me/s/uh1221"}, //  爪
  { url: "https://t.me/s/techisrael"}, // 拽 砖专
  { url: "https://t.me/s/tzap1"} // 爪驻 
];
const GOOGLE_CHAT_WEBHOOK_URL = "https://chat.googleapis.com/v1/spaces/AAQA5xuwKTY/messages?key=AIzaSyDdI0hCZtE6vySjMm-WEfRq3CPzqKqqsHI&token=cl5AwLRkDdQlMmRccVnwoIfJjfEFziZ2GygGrt7hXZg";
const DELAY_BETWEEN_MESSAGES_MS = 1000; // 专转 -1000ms, 转   注 转拽 注转 住.


/**
 * 驻拽爪 专砖转 拽转 注转 砖转 注专爪 专.
 */
function checkForNewMessages() {
  //  转专  注专 砖转砖 , 注爪专 转 驻拽爪
  if (props.getProperty("专专") && props.getProperty("专专") !== email) {
    console.log(`转专  砖. 砖转砖 : ${email}, 转专 爪: ${props.getProperty("专专")}`);
    return;
  }

  TELEGRAM_CHANNELS.forEach(channel => {
    const lastMessageId = PropertiesService.getScriptProperties().getProperty(`lastMessageId_${channel.url}`) || "0";
    
    let response;
    try {
      response = UrlFetchApp.fetch(channel.url, { muteHttpExceptions: true });
    } catch (e) {
      console.error(`砖 -UrlFetchApp.fetch 注专: ${channel.url} - ${e.message}`);
      // 拽 转 砖转 HTTP  429
      if (e.message.includes("returned code 429")) {
        console.error(`砖转 住 (429) 注转 砖驻转 注专抓: ${channel.url}. 住 祝 砖转砖.`);
        switchUser(`砖转 住 砖驻转 专: ${e.message}`);
        return; // 注爪专 转 专爪 转 注专 注专抓 
      }
      return;
    }

    if (response.getResponseCode() === 429) {
      console.error(`砖转 住 (429) 注专 注专抓: ${channel.url}. 住 祝 砖转砖.`);
      switchUser(`砖转 住 砖驻转 专: ${response.getContentText()}`);
      return; // 注爪专 转 专爪 转 注专 注专抓 
    }

    if (response.getResponseCode() !== 200) {
      console.error(`砖 砖驻转 祝 专: ${channel.url} - 拽 转: ${response.getResponseCode()}`);
      return;
    }

    const html = response.getContentText();
    const channelInfo = getChannelInfo(html);
    const messages = parseMessagesFromHtml(html);
    let newLastMessageId = parseInt(lastMessageId);

    messages.forEach(message => {
      if (message.id > newLastMessageId) {
        if (message.videoUrl) {
          message.videoUrl = uploadVideoToDrive(message.videoUrl);
        }
        
        // 住 砖  爪' 注 驻 砖转 住
        try {
          sendCardToGoogleChat(message, channelInfo);
        } catch (e) {
          if (e.message.includes("returned code 429")) {
            console.error(`砖转 住 (429) 注转 砖  爪' 注专 注 ${message.id}. 住 祝 砖转砖: ${e.message}`);
            switchUser(`砖转 住  爪': ${e.message}`);
            return; // 注爪专 转  转 (forEach)   住转 砖 注 注转
          } else {
            console.error(`砖 专转 砖  爪': ${e.message}`);
            // 转 住祝  驻 住祝 砖转 砖 429
            return;
          }
        }
        newLastMessageId = Math.max(newLastMessageId, message.id);
        Utilities.sleep(DELAY_BETWEEN_MESSAGES_MS);
      }
    });

    if (newLastMessageId > parseInt(lastMessageId)) {
      PropertiesService.getScriptProperties().setProperty(`lastMessageId_${channel.url}`, newLastMessageId.toString());
    }
  });
}

/**
 * 注 拽抓  转转 转专 -Google Drive.
 * @param {string} url - 转转 -URL 砖 拽抓 .
 * @returns {string|null} - 转转 -URL 砖 拽抓 -Drive,  null 拽专 砖 砖.
 */
function uploadVideoToDrive(url) {
  try {
    Utilities.sleep(5000); // 转 驻 专转 
    const response = UrlFetchApp.fetch(url, { muteHttpExceptions: true });
    if (response.getResponseCode() !== 200) {
      console.error(`砖 专转 住专: ${url} - 拽 转: ${response.getResponseCode()}`);
      return null;
    }
    const blob = response.getBlob();
    const folder = DriveApp.getFolderById(FOLDER_ID);
    const files = folder.getFilesByName("砖 砖砖转");
    let count = 1;
    while (files.hasNext()) {
      files.next();
      count++;
    }
    const fileName = `砖 砖砖转 ${count}.mp4`;
    const file = folder.createFile(blob.setName(fileName));
    return file.getUrl();
  } catch (error) {
    console.error("砖 注转 住专 专: ", error.message);
    return null;
  }
}

/**
 * 抓 注 注 注专抓 转 拽 -HTML.
 * @param {string} html - 拽 -HTML 砖 祝 注专抓.
 * @returns {object} - 拽  转 砖 注专抓 转转 驻专驻 砖.
 */
function getChannelInfo(html) {
  const nameMatch = html.match(/<meta property="og:title" content="([^"]+)"/);
  const imageMatch = html.match(/<meta property="og:image" content="([^"]+)"/);
  return {
    name: nameMatch ? nameMatch[1] : "Unknown Channel",
    imageUrl: imageMatch ? imageMatch[1] : ""
  };
}

/**
 * 转 注转 转 拽 -HTML 砖 祝 注专抓.
 * @param {string} html - 拽 -HTML 砖 祝 注专抓.
 * @returns {Array<object>} - 注专 砖 拽,   爪 注.
 */
function parseMessagesFromHtml(html) {
  const messages = [];
  const messageBlocks = html.match(/<div class="tgme_widget_message_wrap js-widget_message_wrap"[\s\S]*?<\/div><\/div>/g) || [];
  messageBlocks.forEach(block => {
    const idMatch = block.match(/data-post="[^"]*?\/(\d+)"/);
    if (!idMatch) return;
    const messageId = parseInt(idMatch[1]);
    const textMatch = block.match(/<div class="tgme_widget_message_text js-message_text"[^>]*>([\s\S]*?)<\/div>/);
    let text = textMatch ? cleanText(textMatch[1]) : "";
    text = text.replace(/https:\/\/drive\.google\.com\/file\/d\/([^\/]+)\/view\?usp=[^&]+/g, function(match, fileId) {
      return `https://drive.google.com/file/d/${fileId}/view?usp=drivesdk`;
    });
    text = text.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1">$1</a>'); // 驻 拽 爪
    const imageMatch = block.match(/background-image:url\(['"]?([^'")]+)['"]?\)/);
    const imageUrl = imageMatch ? imageMatch[1] : "";
    const videoMatch = block.match(/<video[^>]+src="([^"]+)"/);
    const videoUrl = videoMatch ? videoMatch[1] : "";
    const timeMatch = block.match(/<time datetime="([^"]+)"/);
    const timestamp = timeMatch ? new Date(timeMatch[1]) : new Date();
    messages.push({
      id: messageId,
      text: text,
      imageUrl: imageUrl,
      videoUrl: videoUrl,
      timestamp: timestamp.toISOString()
    });
  });
  return messages.sort((a, b) => a.id - b.id);
}

/**
 * 拽 拽住 注转 专, 住专 转 HTML   专爪.
 * @param {string} text - 拽住 拽专.
 * @returns {string} - 拽住 拽.
 */
function cleanText(text) {
  return text
    .replace(/<br\s*\/?>/g, '\n')
    .replace(/<[^>]+>/g, '')
    .replace(/&quot;/g, '"')
    .replace(/&amp;/g, '&')
    .replace(/&lt;/g, '<')
    .replace(/&gt;/g, '>')
    .replace(/https?:\/\/chat\.whatsapp\.com\/[^\s]+/g, '')
    .replace(/https?:\/\/wa\.link\/[^\s]+/g, '')
    .replace(/\s*爪专驻转 住驻:\s*\n?/g, '')
    .replace(/\s*住住:\s*\n?/g, '')
    .replace(/https?:\/\/t\.me\/[^\s]+/g, '')
    .replace(/https?:\/\/telegram\.me\/[^\s]+/g, '')
    .replace(/\s*爪专驻 注专抓 专 砖:\s*\n?/g, '')
    // 驻转 砖转 砖拽砖转:
    .replace(/驻  - The Right Way 专:\s*[^\s]*/g, '')
    .replace(/驻  - The Right Way 住驻:\s*[^\s]*/g, '')
    .replace(/砖转祝 WhatsApp ./g, '')
    // 住祝 驻转 砖转
    .replace(/https?:\/\/did\.li\/FidYamin/g, '')
    .replace(/注拽 专 '砖转   爪专'  驻驻专转: 住专 \| 拽拽 \| 专/g, '')
    .replace(/ 爪专 砖转 砖专 专: [^\s]*/g, '')
    .replace(/拽爪转 住驻: [^\s]*/g, '')
    .trim();
}

/**
 * 砖 注 注爪转 专住 -Google Chat.
 * @param {object} message - 拽 注.
 * @param {object} channelInfo - 注 注 注专抓 专.
 */
function sendCardToGoogleChat(message, channelInfo) {
  const formattedDate = new Date(message.timestamp).toLocaleString("he-IL", { timeZone: "Asia/Jerusalem" });
  const sections = [];

  if (message.text.trim()) {
    sections.push({ "widgets": [{ "textParagraph": { "text": message.text } }] });
  }
  if (message.imageUrl) {
    sections.push({ "widgets": [{ "image": { "imageUrl": message.imageUrl } }] });
  }
  if (message.videoUrl) {
    sections.push({ "widgets": [{ "textParagraph": { "text": ` <a href='${message.videoUrl}'>抓  爪驻 住专</a>` } }] });
  }

  if (sections.length === 0) return; //  转砖 专住 专拽

  const card = {
    "cardsV2": [{
      "cardId": "telegramMessage",
      "card": {
        "header": {
          "title": channelInfo.name,
          "subtitle": formattedDate,
          "imageUrl": channelInfo.imageUrl,
          "imageType": "CIRCLE"
        },
        "sections": sections
      }
    }]
  };

  UrlFetchApp.fetch(GOOGLE_CHAT_WEBHOOK_URL, {
    "method": "post",
    "contentType": "application/json",
    "payload": JSON.stringify(card)
  });
}

/**
 * 驻拽爪 砖转 拽住 驻砖 爪' (爪专 转专/ 砖 驻转 砖转砖).
 * 专砖转 专转 GOOGLE_CHAT_WEBHOOK_URL.
 * @param {string} text - 拽住 砖.
 * @param {string} spaceUrl - 转转 -webhook 砖 专 爪'.
 */
function sendTextToChat(text, spaceUrl) {
  const payload = JSON.stringify({ "text": text });
  try {
    UrlFetchApp.fetch(spaceUrl, {
      method: 'post',
      contentType: 'application/json',
      payload: payload,
      muteHttpExceptions: true
    });
  } catch (e) {
    console.error(`砖 砖转 转专转 拽住 爪': ${e.message}`);
  }
}

/**
 * 驻拽爪 驻转 砖转砖 注转 砖转 住转 砖砖.
 * @param {string} error - 砖转 砖 砖专 驻.
 */
function switchUser(error) {
  // 拽 转 住驻专 砖转砖  专砖
  const currentUserIndex = emails.findIndex(e => e.email === email);
  if (currentUserIndex === -1) {
    console.error(` ${email}  爪 专砖转 砖转砖.  转 祝 砖转砖.`);
    sendTextToChat(`砖转 专:  ${email}  爪 专砖转 砖转砖.`, GOOGLE_CHAT_WEBHOOK_URL);
    return;
  }

  const nextUserIndex = (currentUserIndex + 1) % emails.length;
  // 拽 转 转转  砖 砖转砖 
  const nextEmail = emails[nextUserIndex].email;
  // 拽 转 砖 爪 砖 砖转砖 
  const nextName = emails[nextUserIndex].name;

  // 拽转 专专 砖转 注转 注专 砖转砖 
  ScriptApp.getProjectTriggers().forEach(trigger => {
    if (trigger.getHandlerFunction() === "checkForNewMessages") {
      ScriptApp.deleteTrigger(trigger);
      console.log(`专专 'checkForNewMessages' 拽 注专 ${email}.`);
    }
  });

  // 砖专 -PropertiesService 砖 驻专拽  转  砖 砖转砖  转专
  props.setProperty("专专", nextEmail);
  console.log(`注专转 转 转专 砖转砖 : ${nextName} (${nextEmail}).`);

  //  砖砖 专专  驻拽爪转 拽转 转专
  ensureSingleCheckTrigger();
  
  // 注 爪' 住 注 注专转 转专 (注 转  砖转转驻)
  sendTextToChat(`砖转 砖: ${error}\n注专 转 转驻拽 **${nextName}** (${nextEmail}).`, GOOGLE_CHAT_WEBHOOK_URL);
}

/**
 * 驻拽爪 拽转 专专 砖 拽 拽转 转专.
 * 驻注转 爪注转 专专  转拽驻转.
 */
function checkTriggers() {
  //  驻 "专专" 砖 拽 专 转转  砖
  if (props.getProperty("专专") === email) {
    console.log(`转专 砖! ${email} - 转 驻.`);
    
    // 拽 转 专专 -checkTriggers 
    ScriptApp.getProjectTriggers().forEach(trigger => {
      if (trigger.getHandlerFunction() === "checkTriggers") {
        ScriptApp.deleteTrigger(trigger);
        console.log(`专专 'checkTriggers' 拽 注专 ${email}.`);
      }
    });

    // 爪专 专专 砖 砖转 注转 (checkForNewMessages)
    //  砖 专 驻 爪专,   拽.
    ScriptApp.newTrigger("checkForNewMessages").timeBased().everyMinutes(1).create();
    console.log(`专专 砖 'checkForNewMessages' 爪专 注专 ${email}.`);
    
    //  砖驻 "专专" 注 专  
    props.setProperty("专专", email);
    
    // 专 注 拽转 转专 爪'
    sendTextToChat(`**${emails.find(e => e.email === email).name}** 拽转 转 转专, 转 转 注!`, GOOGLE_CHAT_WEBHOOK_URL);
  } else {
    console.log(`注  转专. 砖转砖 : ${email}, 转专 爪: ${props.getProperty("专专")}`);
  }
}

/**
 * 驻拽爪 砖拽 专专 驻 砖 "checkTriggers" 砖专 专拽 .
 * 专爪 专抓 转 驻注 转 转  住祝 转 驻拽爪转 转拽 专砖转.
 */
function ensureSingleCheckTrigger() {
  let checkTriggerCount = 0;
  
  ScriptApp.getProjectTriggers().forEach(trigger => {
    if (trigger.getHandlerFunction() === "checkTriggers") {
      checkTriggerCount++;
      if (checkTriggerCount > 1) {
        ScriptApp.deleteTrigger(trigger); // 拽 专专 住驻
        console.log(`专专 驻 'checkTriggers' 拽.`);
      }
    }
  });

  //    专专 checkTriggers, 爪专 
  if (checkTriggerCount === 0) {
    ScriptApp.newTrigger("checkTriggers").timeBased().everyMinutes(5).create();
    console.log(`爪专 专专 专砖 -'checkTriggers'.`);
  }
}

/**
 * 驻拽爪 驻注 专砖转 砖 住拽专驻  砖转砖.
 * 砖 专抓 转 驻注 转 转 专 注转拽转 住拽专驻.
 */
function setupInitialTrigger() {
  //  砖专专 专砖 砖转 注转 驻注 专拽   砖转砖 专砖 转专
  if (!props.getProperty("专专")) { //  祝   专 专注
    props.setProperty("专专", emails[0].email); // 专 转 专砖 专砖 驻注
    if (emails[0].email === email) { //   砖转砖 专砖
      ScriptApp.newTrigger("checkForNewMessages").timeBased().everyMinutes(1).create();
      console.log(`专转 专专 专砖 'checkForNewMessages' 注专 ${email} (砖转砖 专砖).`);
    } else {
      console.log(`专转 转 砖转砖 专砖 (${emails[0].email}) 驻注. 注转拽  转 转专.`);
    }
  }

  //  砖拽 专专  拽转 转专  注转拽 住拽专驻
  ensureSingleCheckTrigger();
  console.log(`专转 专专 专砖转 住转 注专: ${email}`);
}
  </script>
</body>
</html>
